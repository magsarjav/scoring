
const burenJson = `{
"customer": {
    "firstname": "bat",
        "lastname": "batin bat",
            "address": null,
                "registerno": "ФФ88010255",
                    "familyname": null,
                        "nationality": null
},
"count": 10,
    "pdf": null,
        "liveStocks": null,
            "liveStockDetail": null,
                "inquiry": [
                    {
                        "ROWNUM": 1,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээлийн шугам",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 183000.0,
                        "EXPDATE": "2026-02-20",
                        "STARTEDDATE": "2018-08-20",
                        "PAID_DATE": null,
                        "INTERESTINPREC": null,
                        "BALANCE": 56000000.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Очир Ундраа ОМЗ ББСБ",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 2,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2026-07-15",
                        "STARTEDDATE": "2010-05-01",
                        "PAID_DATE": null,
                        "INTERESTINPREC": 2.9,
                        "BALANCE": 7000000.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 3,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2010-09-15",
                        "STARTEDDATE": "2010-07-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 4,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2010-11-15",
                        "STARTEDDATE": "2010-09-15",
                        "PAID_DATE": "2020-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Анхаарал хандуулах",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 5,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2010-12-15",
                        "STARTEDDATE": "2010-11-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 6,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2011-01-15",
                        "STARTEDDATE": "2010-12-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 7,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2011-02-15",
                        "STARTEDDATE": "2011-01-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 8,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2024-03-15",
                        "STARTEDDATE": "2011-02-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 10000000.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 9,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2011-04-15",
                        "STARTEDDATE": "2011-03-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    },
                    {
                        "ROWNUM": 10,
                        "AA_ORGCODE": null,
                        "AA_LOANCODE": null,
                        "LASTNAME": "batin bat",
                        "CUSTOMERNAME": "bat",
                        "REGISTERNO": "ФФ88010255",
                        "LOANTYPE": "Зээл",
                        "CURRENCYCODE": "MNT",
                        "ADVAMOUNT": 0.0,
                        "EXPDATE": "2025-05-15",
                        "STARTEDDATE": "2011-04-15",
                        "PAID_DATE": "2023-07-03",
                        "INTERESTINPREC": null,
                        "BALANCE": 0.0,
                        "LOANCLASS": "Хэвийн",
                        "SUBMRTNAME": [],
                        "STATEREGISTERNO": [],
                        "ORGNAME": "Эй Ай Лаб",
                        "DESCRIPTION": null,
                        "COREGISTERNO": null,
                        "COLASTNAME": null,
                        "COFIRSTNAME": null,
                        "COSTATEREGISTERNO": null,
                        "RELATION_TYPE": "MAIN",
                        "SUBMRT": []
                    }
                ],
                "xypResultCode": null,
                "histories": [
                    {
                        "requester": "Бүрэн скор ЗМС ХХК",
                        "requestedDate": "2024-03-25 13:00:25",
                        "purpose": "NEW_LOAN"
                    },
                    {
                        "requester": "Бүрэн скор ЗМС ХХК",
                        "requestedDate": "2024-03-25 13:00:22",
                        "purpose": "NEW_LOAN"
                    },
                    {
                        "requester": "Бүрэн скор ЗМС ХХК",
                        "requestedDate": "2024-03-12 16:30:01",
                        "purpose": "LOAN"
                    }
                ]
}`;

// Дан систем рүү хүсэлт илгээхдээ огноог сүүлийн 3 сарын дата ирдэг байхаар тохируулна
// Жишээлбэл өнөөдөр 2024.02 сар байг, тэгвэл 2023 оны болон 2024 оны мэдээллийг 2ланг татхаар хүсэлтээ илгээнэ гэсэ үг
const danJson = `{
    "list": [
        {
            "isPaid": 0,
            "orgName": "",
            "orgId": "",
            "salaryAmount": 1800000,
            "salaryFee": 220000,
            "year": 2024,
            "month": 1
        },
        {
            "isPaid": 1,
            "orgName": "",
            "orgId": "",
            "salaryAmount": 1900000,
            "salaryFee": 300000,
            "year": 2023,
            "month": 12
        },
        {
            "isPaid": 1,
            "orgName": "",
            "orgId": "",
            "salaryAmount": 1900000,
            "salaryFee": 300000,
            "year": 2023,
            "month": 11
        },
        {
            "isPaid": 1,
            "orgName": "",
            "orgId": "",
            "salaryAmount": 1900000,
            "salaryFee": 300000,
            "year": 2024,
            "month": 2
        }
    ]
}`;

const RESPONSE_MESSAGE = ["Чанаргүй зээлийн түүхтэй", "Сард төлөх нийт зээл орлогоосоо давсан", "Амжилттай"];
const INTEREST_RATE = [1.014, 1.02]; // Bank, BSB 
const TOP4_BANK = ["Хаан банк", "Голомт банк", "ХХБ", "Төрийн банк"];
const LAST_MONTH_SALARY = 3;


const AGE_BONUS_TRESHOLD = 23;
const PHONE_BONUS_A = ["8888", "9911", "8811"];
const PHONE_BONUS_B = ["9900", "9901", "9902", "9903", "9904", "9905", "9906", "9907", "9908", "9909", "9910", "9917", "9919"];
const BONUS_AMOUNT = [150000, 200000, 250000, 300000];

const LOAN_K = [0.0, 0.6, 0.7, 0.8, 1.0];
const LIVING_COST = 0.7;

// Бонус оноо тооцох функц
function calcBonusPoint(registerNo, phoneNo, top4, rpHistory) {
    genderBonus = 0;
    ageBonus = 0;
    phoneBonus = 0;
    top4Bonus = 0;
    rpBonus = 0;

    // calc gender bonus
    gender = registerNo.charAt(8);
    if (parseInt(gender, 10) % 2 == 0) {
        genderBonus = 1;
    }

    // calc age bonus
    bDayStr = registerNo.slice(2, 8);
    if (parseInt(bDayStr.slice(0, 2), 10) < 10) {
        m = bDayStr.slice(2, 3);
        month = '0';
        if (m == '3') {
            month = '1';
        }
        month = month + bDayStr.slice(3, 4);
        bDayStr = "20" + bDayStr.slice(0, 2) + "-" + month + "-" + bDayStr.slice(4, 6);
    } else {
        bDayStr = "19" + bDayStr.slice(0, 2) + "-" + bDayStr.slice(2, 4) + "-" + bDayStr.slice(4, 6);
    };

    birthDate = new Date(bDayStr);
    today = new Date();
    age = today.getFullYear() - birthDate.getFullYear();
    mDif = today.getMonth() - birthDate.getMonth();
    if (mDif < 0 || (mDif === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    if (age >= AGE_BONUS_TRESHOLD) {
        ageBonus = 1;
    }

    //calc phone bonus
    if (PHONE_BONUS_A.indexOf(phoneNo.slice(0, 4)) > -1) {
        phoneBonus = 2;
    } else if (PHONE_BONUS_B.indexOf(phoneNo.slice(0, 4)) > -1) {
        phoneBonus = 1;
    }

    //calc top4 bonus
    if (top4) {
        top4Bonus = 2;
    }

    //calc rentpay history bonus
    if (rpHistory) {
        rpBonus = 2;
    }

    res = [genderBonus, ageBonus, phoneBonus, top4Bonus, rpBonus];

    return res;
}

//Бонус оноонд харгалзах мөнгөн дүн тооцох функц
function calcBonusAmount(bonusPoint) {
    totalBonus = bonusPoint.reduce((partialSum, a) => partialSum + a, 0);
    bonusIndex = 0;
    if (totalBonus <= 4) {
        bonusIndex = 0;
    } else if (totalBonus == 5) {
        bonusIndex = 1;
    } else if (totalBonus == 6) {
        bonusIndex = 2;
    } else {
        bonusIndex = 3;
    }
    return BONUS_AMOUNT[bonusIndex];
}


//Хэвийн бус зээл шалгаж үржих коэффициент тооцох функц
function calcKIndex(data) {
    K_INDEX = 4;
    RES_MSG_INDEX = 2;

    for (i = 0; i < data.length; i++) {
        if (data[i]["LOANTYPE"] == 'Зээл' || data[i]["LOANTYPE"] == 'Зээлийн шугам') {
            if (data[i]["LOANCLASS"] != 'Хэвийн') {
                if (data[i]["BALANCE"] > 0) {
                    K_INDEX = 0;
                    RES_MSG_INDEX = 0;
                    break;
                } else {
                    paidDate = new Date(data[i]["PAID_DATE"]);
                    today = new Date();
                    duration = today.getFullYear() - paidDate.getFullYear();
                    if (duration <= 3) {
                        K_INDEX = 0;
                        RES_MSG_INDEX = 0;
                        break;
                    } else if (duration == 4) {
                        K_INDEX = Math.min(1, K_INDEX);
                    } else if (duration == 5) {
                        K_INDEX = Math.min(2, K_INDEX);
                    } else if (duration == 6) {
                        K_INDEX = Math.min(3, K_INDEX);
                    }
                }
            }
        }
    }

    return [K_INDEX, RES_MSG_INDEX];
}

//Зээлэндээ сард төлж буй нийт дүнг тооцох функц
function calcLoanAmount(data) {
    amount = 0;
    top4 = false;
    for (i = 0; i < data.length; i++) {
        if (data[i]["LOANTYPE"] == 'Зээл' && data[i]["PAID_DATE"] == null) {
            intIndex = 1; //Bank bus sariin huu
            expDate = new Date(data[i]["EXPDATE"]);
            today = new Date();
            if (today < expDate) {
                yDif = expDate.getFullYear() - today.getFullYear();
                mDif = expDate.getMonth() - today.getMonth();
                remMonth = yDif * 12 + mDif;
                //console.log(expDate + " " + remMonth);
                amount += data[i]["BALANCE"] / remMonth * INTEREST_RATE[intIndex];
            }
        }

        if (data[i]["LOANTYPE"] == 'Зээл' && TOP4_BANK.indexOf(data[i]["ORGNAME"]) > -1) {
            top4 = true;
        }
    }
    return [Math.ceil(amount), top4];
}

//Сарын цэвэр орлого тооцох функц
function calcNetIncome(data) {
    netSalary = 0;

    today = new Date();
    ty = today.getFullYear();
    tm = today.getMonth();

    lm_year = new Array(LAST_MONTH_SALARY);
    lm_month = new Array(LAST_MONTH_SALARY);

    //Сүүлийн LAST_MONTH_SALARY сарыг онтой нь хамт тооцох давталт, JS дээр сар 1-с биш, 0-с эхэлдэг
    for (i = 0; i < LAST_MONTH_SALARY; i++) {
        if (tm - (i + 1) < 0) {
            lm_month[i] = tm - i + 12;
            lm_year[i] = ty - 1;
        } else {
            lm_month[i] = tm - i;
            lm_year[i] = ty;
        }
    }

    console.log(lm_month);
    console.log(lm_year);

    for (i = 0; i < data.length; i++) {
        for (j = 0; j < LAST_MONTH_SALARY; j++) {
            if (data[i]["year"] == lm_year[j] && data[i]["month"] == lm_month[j]) {
                netSalary += data[i]["salaryAmount"] - data[i]["salaryFee"];
                break;
            }
        }
    }

    return Math.ceil((netSalary / LAST_MONTH_SALARY) * LIVING_COST);
}

//Хэрэглэгчийн эрх тооцох функц
//Оролт: Регистрийн дугаар, утасны дугаар, РП түүхтэй эсэх, Бүрэн дата, Дан дата
//Гаралт: Рэнтпэй тогтоосон эрх - Мөнгөн дүн
function calc(registerNo, phoneNo, rpHistory, buren, ndsh) {
    KI = calcKIndex(buren);

    if (KI[1] == 0) {
        console.log(RESPONSE_MESSAGE[0]);
        return 0;
    }

    A = calcLoanAmount(buren);
    B = calcNetIncome(ndsh);

    if (B - A[0] < 0) {
        console.log(RESPONSE_MESSAGE[1]);
        return 0;
    }

    T1 = (B - A[0]) * LOAN_K[KI[0]];

    bonusPoint = calcBonusPoint(registerNo, phoneNo, A[1], rpHistory);
    T2 = calcBonusAmount(bonusPoint);

    //console.log(A[0] + " " + B + " " + T1 + " " + T2);
    console.log(RESPONSE_MESSAGE[2]);

    return Math.ceil(T1 + T2);
}


//Бүрэнгээс ирэх ЗМС-ийн дата
obj = JSON.parse(burenJson);
buren = obj["inquiry"];

//Дангаас ирэх НДШ дата
obj = JSON.parse(danJson);
ndsh = obj["list"];


p1 = calc("ПД88040279", "99270101", false, buren, ndsh);
console.log(p1);

p2 = calc("АД01240484", "88110101", true, buren, ndsh);
console.log(p2);



